name: Debug Validate GCP SA JSON

on:
  workflow_dispatch:

jobs:
  validate-sa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode debug SA key and validate JSON
        id: decode
        run: |
          set -euo pipefail

          # Decodificar secret base64 a un archivo temporal y validar con jq
          printf '%s' "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > /tmp/sa.json
          chmod 600 /tmp/sa.json
          echo "Size (bytes): $(wc -c < /tmp/sa.json)"
          jq -e . /tmp/sa.json

          # Inyectar el JSON decodificado como variable de entorno multilínea SA_JSON
          # (Se escribe en GITHUB_ENV en formato heredoc para preservar los saltos de línea)
          echo "SA_JSON<<EOF" >> $GITHUB_ENV
          cat /tmp/sa.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Authenticate to GCP using decoded credentials_json
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ env.SA_JSON }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform

      - name: Verify authentication / list project info
        run: |
          set -euo pipefail
          echo "GCP_PROJECT (secret) = ${{ secrets.GCP_PROJECT }}"
          # Comprueba que gcloud está usando las credenciales creadas por la action
          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          # Verifica el proyecto y lista policy (requiere permisos)
          gcloud projects describe "${{ secrets.GCP_PROJECT }}" --format="value(projectId)"
          gcloud projects get-iam-policy "${{ secrets.GCP_PROJECT }}" --format=json | jq 'keys'

      - name: Clean up SA key file
        if: always()
        run: |
          # Borra el archivo local de credenciales
          shred -u /tmp/sa.json || rm -f /tmp/sa.json || true
