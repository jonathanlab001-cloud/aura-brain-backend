name: Debug Validate GCP SA JSON

on:
  workflow_dispatch:

jobs:
  validate-sa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode debug SA key and validate JSON
        id: decode
        run: |
          set -euo pipefail
          # Decodificar secret y exponerlo como output del step
          SA_JSON=$(echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode)
          echo "sa<<EOF" >> $GITHUB_OUTPUT
          echo "$SA_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          # Validar el JSON para fallar rápido si está corrupto
          echo "$SA_JSON" | jq -e .

      - name: Authenticate to GCP using decoded credentials_json
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ steps.decode.outputs.sa }}

      - name: Verify authentication / list project info
        run: |
          set -euo pipefail
          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          gcloud projects describe "${{ secrets.GCP_PROJECT }}" --format="value(projectId)"

