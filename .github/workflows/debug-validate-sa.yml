name: Debug Validate GCP SA JSON

on:
  workflow_dispatch:

jobs:
  validate-sa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode debug SA key and validate JSON
        id: decode
        run: |
          set -euo pipefail

          # Decodificar secret base64 a un archivo temporal y validar con jq
          printf '%s' "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > /tmp/sa.json
          chmod 600 /tmp/sa.json
          echo "Size (bytes): $(wc -c < /tmp/sa.json)"
          jq -e . /tmp/sa.json

          # Exponer el JSON decodificado como output del step (multilínea)
          echo "sa<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/sa.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Authenticate to GCP using decoded credentials_json (from step output)
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ steps.decode.outputs.sa }}
          create_credentials_file: true
          export_environment_variables: true
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform

      - name: Verify authentication / list project info
        run: |
          set -euo pipefail
          echo "GCP_PROJECT (secret) = ${{ secrets.GCP_PROJECT }}"
          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          gcloud projects describe "${{ secrets.GCP_PROJECT }}" --format="value(projectId)"
          gcloud projects get-iam-policy "${{ secrets.GCP_PROJECT }}" --format=json | jq 'keys'

      - name: Clean up SA key file
        if: always()
        run: |
          shred -u /tmp/sa.json || rm -f /tmp/sa.json || true
